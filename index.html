<!DOCTYPE html>
<!--
  Quiddler Scoring App
  - UI: Tailwind-based form for players, rounds, and a tools drawer (Dictionary + Solver)
  - Scripts load order:
      1) Data: collins_dictionary.js, card_scores.js, common_lemmas.js
      2) ESM: wink-lemmatizer (needed by Solver common-word filter)
      3) App: dictionary_api.js, scoring.js, render.js, optimizer.js, game.js, tools_drawer.js
  - Entry points used by the page: startGame(), nextRound(), initToolsDrawer()
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiddler Scoring App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tippy.js Tooltip Dependencies -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css"/>
    <style>
      /* Align player round input rows: fixed label column + flexible input column */
      .player-input-row { display: grid; grid-template-columns: 16ch 1fr; gap: 0.5rem; align-items: center; }
      @media (min-width: 640px) { /* sm */
        .player-input-row { grid-template-columns: 20ch 1fr; }
      }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6">
        <h1 class="text-2xl font-bold mb-4">Quiddler Scoring App</h1>

        <!-- Pre-game config (visible until a game starts) -->
        <div id="preGameConfig" class="mb-4">
            <!-- Player names -->
            <label class="block font-semibold">Player Names (comma separated):</label>
            <input id="playersInput" class="w-full p-2 border rounded mt-2" placeholder="e.g., Alice,Bob,Charlie">

            <!-- Bonus settings -->
            <div class="mt-2 space-y-2">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="longestWordBonus">
                    <label for="longestWordBonus">Longest Word Bonus ðŸ¦’</label>
                    <input id="longestWordPoints" type="number" value="10" min="0"
                        class="w-16 border rounded p-1">
                    <span>points</span>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="mostWordsBonus">
                    <label for="mostWordsBonus">Most Words Bonus ðŸ¥’</label>
                    <input id="mostWordsPoints" type="number" value="10" min="0"
                        class="w-16 border rounded p-1">
                    <span>points</span>
                </div>
                <!-- New: starting / ending number of cards -->
                <div class="flex items-center flex-wrap gap-2 text-sm">
                  <span>Play with</span>
                  <input id="startCards" type="number" min="3" max="30" value="3" class="w-16 border rounded p-1 text-right" aria-label="Starting number of cards">
                  <span>to</span>
                  <input id="endCards" type="number" min="1" max="30" value="10" class="w-16 border rounded p-1 text-right" aria-label="Ending number of cards">
                  <span>cards</span>
                </div>
            </div>

            <!-- Start Game button -->
            <button id="gameGo" class="mt-3 bg-blue-500 text-white py-2 px-4 rounded">Start Game</button>
        </div>

        <!-- Game Area -->
        <div id="gameArea" class="hidden">
            <h2 class="font-semibold text-xl mb-2" id="roundHeader"></h2>

            <!-- Player round inputs -->
            <div id="scoreInputs"></div>

            <!-- Actions -->
            <div class="mt-3 flex items-center gap-2">
              <button id="submitRoundBtn" class="bg-blue-500 text-white py-2 px-4 rounded">Submit Round</button>
              <button id="newGameBtn" class="bg-blue-500 text-white py-2 px-4 rounded">New Game</button>
              <button id="endGameBtn" class="bg-red-600 text-white py-2 px-4 rounded hidden">End Game</button>
            </div>

            <!-- Overall summary -->
            <h3 id="runningTotalsHeader" class="font-semibold text-xl mt-6 hidden">Running Totals</h3>
            <ul id="scoreTotals" class="list-disc pl-6"></ul>

            <!-- Round details -->
            <h3 id="previousRoundsHeader" class="font-semibold text-xl mt-6 hidden">Previous Rounds</h3>
            <div id="previousRoundsHint" class="text-sm text-gray-500 mt-1 hidden">
              Click a word chit to toggle a challenge. Click again to undo.
            </div>
            <div id="previousRounds" class="mt-2"></div>
        </div>
    </div>

    <!-- Tools Drawer Toggle Button -->
    <div class="fixed bottom-6 right-6 flex flex-col gap-3 z-50">
      <button id="dictToolBtn"
              class="w-14 h-14 rounded-full bg-gray-500 hover:bg-gray-600 flex items-center justify-center shadow-lg"
              aria-label="Dictionary (âŒ˜/Ctrl+I)"
              data-tippy-content="Dictionary (âŒ˜/Ctrl+I)"
              type="button">
        <img src="https://cdn.jsdelivr.net/npm/heroicons@2.1.5/24/outline/book-open.svg"
             class="w-7 h-7 invert" alt="" />
      </button>

      <button id="optToolBtn"
              class="w-14 h-14 rounded-full bg-gray-500 hover:bg-gray-600 flex items-center justify-center shadow-lg"
              aria-label="Solver (âŒ˜/Ctrl+O)"
              data-tippy-content="Solver (âŒ˜/Ctrl+O)"
              type="button">
        <img src="https://cdn.jsdelivr.net/npm/heroicons@2.1.5/24/outline/cog-6-tooth.svg"
             class="w-7 h-7 invert" alt="" />
      </button>
    </div>

    <!-- Backdrop -->
    <div id="toolsBackdrop"
         class="fixed inset-0 bg-black/30 z-40 hidden opacity-0 transition-opacity"></div>

    <!-- Right Drawer -->
    <aside id="toolsDrawer"
           class="fixed right-0 top-0 h-full w-[24rem] max-w-[90vw] bg-white z-50 shadow-xl border-l border-gray-200
                  transform translate-x-full transition-transform">
      <!-- Header -->
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
        <div class="font-semibold text-gray-800">Quiddler Tools</div>
        <button id="toolsCloseBtn" class="text-gray-500 hover:text-gray-700 text-xl leading-none">âœ•</button>
      </div>

      <!-- Tabs -->
      <div class="px-4 pt-3">
        <div class="inline-flex text-sm rounded-lg overflow-hidden border border-gray-200">
          <button id="toolsTabDict" class="px-3 py-2 bg-white text-gray-900">Dictionary</button>
          <button id="toolsTabPlay" class="px-3 py-2 bg-gray-100 text-gray-600">Solver</button>
        </div>
      </div>

      <!-- Panels -->
      <div class="p-4 flex flex-col gap-4 overflow-y-auto h-[calc(100%-4.5rem-3rem)]">
        <!-- Dictionary panel -->
        <section id="toolsPanelDict">

          <div id="dictEmpty" class="mb-3 text-sm text-gray-500">Type a word to look up.</div>
          <div class="flex items-center gap-2 mb-3">
            <input id="dictInput" type="text" placeholder="Type a wordâ€¦" class="flex-1 border rounded-lg px-3 py-2 outline-none focus:ring focus:ring-blue-200"/>
          </div>

          <!-- Dictionary content -->
          <div id="dictContent" class="space-y-3">
            <!-- Local definition -->
            <div id="dictLocalWrap" class="hidden">
              <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Collins â€™19</div>
              <div id="dictLocal" class="text-sm text-gray-800"></div>
            </div>
            <!-- Online definition -->
            <div id="dictOnlineWrap" class="hidden">
              <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Online Dictionary</div>
              <div id="dictOnline" class="text-sm text-gray-800"></div>
            </div>
            <!-- Loading -->
            <div id="dictOnlineLoading" class="hidden text-xs text-gray-500">Looking upâ€¦</div>
          </div>

        </section>

        <!-- Play Helper panel -->
        <section id="toolsPanelPlay" class="hidden">
          <!-- Tiles -->
          <div id="tilesEmpty" class="mb-3 text-sm text-gray-500">
            Enter your hand, using parentheses around digraphs.<br>Tip: spaces and '-' will be ignored.
          </div>

          <!-- Tiles input -->
          <div>
            <input id="tilesInput" type="text" placeholder="e.g. (qu)i ck(er)"
                   class="w-full border rounded-lg px-3 py-2 outline-none focus:ring focus:ring-blue-200"/>
          </div>

          <!-- New: "Do not discard a card" -->
          <div class="mt-3">
            <label class="inline-flex items-center gap-2">
              <input id="optNoDiscard" type="checkbox" class="rounded">
              <span class="text-sm">Do not discard any card</span>
            </label>
          </div>

          <!-- Common/Zipf controls -->
          <div class="mt-4 mb-2 space-y-2">
            <label class="flex flex-wrap items-center gap-2">
              <input id="optCommonOnly" type="checkbox" class="rounded">
              <span class="text-sm">
                Use only words with a
                <a href="https://en.wikipedia.org/wiki/Zipf%27s_law" target="_blank" rel="noopener noreferrer"
                   class="text-blue-600 hover:underline">Zipf</a>
                score of:
                <span id="zipfVal" class="font-semibold">2.0</span>
              </span>
            </label>
            <input id="optZipf" type="range" min="0" max="5" step="0.1" value="2.0"
                   class="w-full accent-blue-600">
            <label class="inline-flex items-center gap-2">
              <input id="optCommonOverride" type="checkbox" class="rounded">
              <span class="text-sm">Except include all 2 and 3 letter words</span>
            </label>
          </div>

          <!-- Current Longest / Current Most -->
          <div id="currentBonuses" class="grid grid-cols-2 gap-3 hidden">
            <div>
              <label for="optCurrentLongest" class="block text-sm font-medium text-gray-700 mb-1">Longest word to beat</label>
              <input id="optCurrentLongest" type="number" min="0" step="1" value="0"
                     class="w-full border rounded-lg px-3 py-2 text-right outline-none focus:ring focus:ring-blue-200"/>
            </div>
            <div>
              <label for="optCurrentMost" class="block text-sm font-medium text-gray-700 mb-1">Most words to beat</label>
              <input id="optCurrentMost" type="number" min="0" step="1" value="0"
                     class="w-full border rounded-lg px-3 py-2 text-right outline-none focus:ring focus:ring-blue-200"/>
            </div>
          </div>

          <!-- Action + Status -->
          <div class="mt-3 pt-2 flex items-center gap-2">
            <button id="playGo" class="bg-blue-500 text-white px-3 py-2 rounded-lg">
              Solve
            </button>
            <span id="playStatus" class="text-sm text-gray-500"></span>
          </div>

          <!-- Results -->
          <div id="playResult" class="mt-2 hidden"></div>

        </section>
      </div>
    </aside>

    <!-- End Game Summary Modal -->
    <div id="endGameModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-4">
        <h3 class="text-xl font-semibold mb-3">Game Over</h3>
        <div id="endGameSummary" class="mb-4 text-sm"></div>
        <div class="flex justify-end gap-2">
          <button id="endModalCloseBtn" class="px-4 py-2 rounded border">Close</button>
          <button id="endModalNewBtn" class="px-4 py-2 rounded bg-blue-600 text-white">New Game</button>
        </div>
      </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-5 w-[420px] text-sm">
        <h3 class="font-semibold mb-3">Keyboard Shortcuts</h3>
        <ul class="space-y-1 leading-5">
          <li><span class="font-mono bg-gray-100 px-1 py-0.5 rounded">Ctrl/Cmd + Enter</span> New game</li>
          <li><span class="font-mono bg-gray-100 px-1 py-0.5 rounded">Ctrl/Cmd + E</span> End game</li>
          <li><span class="font-mono bg-gray-100 px-1 py-0.5 rounded">Ctrl/Cmd + I</span> Open dictionary</li>
          <li><span class="font-mono bg-gray-100 px-1 py-0.5 rounded">Ctrl/Cmd + O</span> Open solver</li>
          <li><span class="font-mono bg-gray-100 px-1 py-0.5 rounded">Ctrl/Cmd + /</span> Toggle this panel</li>
        </ul>
        <div class="mt-4 text-right">
          <button id="shortcutCloseBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs">Close (Esc)</button>
        </div>
      </div>
    </div>

    <!-- Subtle footer hint -->
    <div class="mt-6 text-center text-[11px] text-gray-400 select-none">
      Press <span class="font-mono">Cmd+/</span> (Ctrl+/) for shortcuts
      <button onclick="window.QuiddlerToggleShortcuts?.()" class="ml-2 underline decoration-dotted">help</button>
    </div>

    <!-- Core data and helpers -->
    <script src="card_scores.js"></script>
    <script src="collins_dictionary.js"></script>
    <script src="common_lemmas.js"></script>

    <!-- Wink lemmatizer (ESM) -->
    <script type="module">
      import lemmatizer from "https://cdn.jsdelivr.net/npm/wink-lemmatizer/+esm";
      window.winkLemmatizer = lemmatizer;
    </script>

    <!-- Split app scripts -->
    <script src="dictionary_api.js"></script>
    <script src="scoring.js"></script>
    <script src="render.js"></script>
    <script src="optimizer.js"></script>
    <script src="game.js"></script>
    <script src="tools_drawer.js"></script>

    <!-- Bootstrap -->
    <script>
      // Initialize the tools drawer and button tooltips
      window.QuiddlerTools?.init ? window.QuiddlerTools.init() : initToolsDrawer();

      // Wire buttons to namespaced APIs (fallback to globals during migration)
      document.getElementById('gameGo')?.addEventListener('click', () => {
        (window.QuiddlerGame?.startGame || window.startGame)?.();
      });
      document.getElementById('submitRoundBtn')?.addEventListener('click', () => {
        (window.QuiddlerGame?.nextRound || window.nextRound)?.();
      });
      document.getElementById('newGameBtn')?.addEventListener('click', () => {
        (window.QuiddlerGame?.resetToPreGame)?.();
      });

      // End game button
      document.getElementById('endGameBtn')?.addEventListener('click', () => {
        (window.QuiddlerGame?.endGame)?.();
      });

      // End game modal buttons
      document.getElementById('endModalCloseBtn')?.addEventListener('click', () => {
        (window.QuiddlerGame?.closeEndGameDialog)?.();
      });
      document.getElementById('endModalNewBtn')?.addEventListener('click', () => {
        (window.QuiddlerGame?.closeEndGameDialog)?.();
        (window.QuiddlerGame?.resetToPreGame)?.();
      });

      // Shortcut modal toggle
      function toggleShortcutModal() {
        const modal = document.getElementById('shortcutModal');
        const isHidden = modal.classList.contains('hidden');
        modal.classList.toggle('hidden', !isHidden);
        modal.classList.toggle('flex', isHidden);
        if (isHidden) {
          modal.focus();
        }
      }

      // NEW: Close button handler for the shortcuts modal
      document.getElementById('shortcutCloseBtn')?.addEventListener('click', () => {
        // Prefer the namespaced helper if available
        if (window.QuiddlerHideShortcuts) {
          window.QuiddlerHideShortcuts();
        } else {
          const modal = document.getElementById('shortcutModal');
          modal?.classList.add('hidden');
          modal?.classList.remove('flex');
        }
      });

      // Global keydown listener for shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          // Close modals on Escape
          document.getElementById('shortcutModal').classList.add('hidden');
        } else if (e.key === '?' && !document.getElementById('shortcutModal').classList.contains('hidden')) {
          // Toggle shortcut modal with ?
          e.preventDefault();
          toggleShortcutModal();
        }
      });

      // Ensure initial focus sticks on pre-game players input
      function focusPlayersIfPreGame() {
        const pre = document.getElementById('preGameConfig');
        const p = document.getElementById('playersInput');
        if (pre && !pre.classList.contains('hidden') && p && !p.disabled) {
          p.focus();
          p.select?.();
        }
      }
      // Run after bootstrap and next tick to avoid any competing focus
      focusPlayersIfPreGame();
      setTimeout(focusPlayersIfPreGame, 0);
      requestAnimationFrame(focusPlayersIfPreGame);
    </script>
</body>
</html>
